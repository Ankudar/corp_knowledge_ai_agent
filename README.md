# corp_knowledge_ai_agent
AI-агент для корпоративных знаний через Telegram. Собирает и нормализует документы, профили сотрудников и заявки, строит векторные индексы, обеспечивает быстрый поиск и генерацию ответов с учётом прав доступа и безопасности. Использует RAG-подход, LLM и хранение данных в Supabase.

## План работ по созданию AI-агента
*(может дорабатываться/дополняться/изменяться/упрощаться/усложняться/вызывать негодование)*

### 0. Входные данные и стек
- [ ] Входы:
  - PDF, DOCX, PPTX, HTML, XSLX
  - Excel: сотрудники
  - Excel: каталог заявок
  - Confluence / Notion / Git / Wiki
- [ ] Технологии:
  - n8n — ingest pipelines
  - Supabase (Postgres + Storage) — метаданные, файлы, RBAC
  - Векторное хранилище (Qdrant/Weaviate/Milvus/Pinecone/Elastic-vector)
  - OpenAI (эмбеддинги + LLM)
  - Telegram Bot API — единственный интерфейс
  - Backend (FastAPI) — webhook + бизнес-логика

### 1. Сбор данных (ingest)
- [ ] Сбор данных из файловых хранилищ, Confluence API, Google Docs API, Notion, Git
- [ ] Сохранение файлов в Supabase Storage
- [ ] Парсинг текста: PDF/OCR, DOCX, PPTX → markdown/plain
- [ ] Извлечение метаданных: владелец, проект, дата, путь, тип
- [ ] Проставление статуса (new/processed/archived)
- [ ] Загрузка и нормализация Excel (employees/requests) → таблицы Supabase
- [ ] Артефакты: staging таблицы + сырые файлы в Storage

### 2. Очистка, нормализация, дедупликация
- [ ] Конвертация всего в markdown/plain
- [ ] Заголовки: owner, project, date, source
- [ ] Дедупликация по хэшу + fuzzy similarity
- [ ] Удаление архивных и старых версий
- [ ] Фильтрация PII/секретных данных (regex + denylist)
- [ ] Логирование всех модификаций
- [ ] Артефакты: cleaned текст + метаданные + журнал редактирования

### 3. Чанкинг и векторизация
- [ ] Разбивка документов на чанки 300–800 токенов
- [ ] Добавление overlap
- [ ] Генерация эмбеддингов (OpenAI или E5/BGE)
- [ ] Формирование payload: текст чанка + owner + link + date + section + source
- [ ] Upsert в vector DB
- [ ] Мини-резюме или первые строки для превью
- [ ] Артефакты: векторные индексы по документам

### 4. Базы знаний сотрудников и заявок
- [ ] Employees:
  - ФИО, роль, навыки, ссылка на профиль, контакт
  - Текстовый профиль
  - Эмбеддинг → vector DB
  - Метаданные → Supabase
- [ ] Requests:
  - Категории, шаблоны заявок, прямые ссылки
  - Embeddings + таблица Supabase
- [ ] Пайплайн через n8n с регулярными обновлениями

### 5. Архитектура агента (runtime)
- [ ] Telegram webhook (FastAPI)
- [ ] Intent Classifier (LLM): document / employee / request / mixed / triage
- [ ] Retriever
- [ ] Reranker (опционально)
- [ ] Context Composer
- [ ] Answer Composer
- [ ] ACL/guardrails
- [ ] Audit: запись всего в Supabase

### 6. Поведение по кейсам
- [ ] Документ: название, владелец, ссылка, summary, выдержки
- [ ] Сотрудник: ФИО, роль, чем может помочь, ссылка, контакты
- [ ] Заявка: тип, прямая ссылка, автогенерация описания, подсказка шагов
- [ ] Mixed: комбинация документов, владельцев и заявок

### 7. Telegram-диалог (UI/UX)
- [ ] Текстовые ответы без меню выбора
- [ ] Inline-кнопки для действий:
  - “Открыть документ”
  - “Профиль сотрудника”
  - “Создать заявку”
- [ ] Хранение контекста диалога в Supabase (user_id, последний intent, история, найденные объекты)

### 8. Безопасность и права доступа
- [ ] RBAC в Supabase
- [ ] ACL в агенте
- [ ] Защита PII и секретной информации
- [ ] Rate limit по Telegram user_id
- [ ] Журнал аудита всех запросов и источников

### 9. Тестирование и метрики
- [ ] Тест-набор запросов
- [ ] Метрики: Retrieval hit-rate, Answer faithfulness, Latency, ACL-ошибки, User feedback
- [ ] Ручной аудит и корректировка промптов

### 10. Обновление данных
- [ ] Автопарсинг новых файлов (cron/n8n)
- [ ] Delta ingest
- [ ] Re-chunk и re-embed
- [ ] Версионирование документов
- [ ] Очистка старых данных и переиндексация

### 11. Продакшн и мониторинг
- [ ] Кэширование популярных запросов
- [ ] Мониторинг: LLM latency, Vector DB latency, Telegram webhook stability
- [ ] Логи ошибок
- [ ] Kill-switch для LLM
- [ ] Возможность быстрого отключения функций
